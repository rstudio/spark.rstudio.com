<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>sparklyr - Text mining with Spark &amp; sparklyr</title>
<style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
<script src="../site_libs/quarto-nav/quarto-nav.js"></script><script src="../site_libs/quarto-nav/headroom.min.js"></script><script src="../site_libs/clipboard/clipboard.min.js"></script><meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script><script src="../site_libs/quarto-search/fuse.min.js"></script><script src="../site_libs/quarto-search/quarto-search.js"></script><link href="../guides/distributed-r.html" rel="next">
<link href="../guides/streaming.html" rel="prev">
<link href="../images/favicon/apple-touch-icon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script><script src="../site_libs/quarto-html/popper.min.js"></script><script src="../site_libs/quarto-html/tippy.umd.min.js"></script><script src="../site_libs/quarto-html/anchor.min.js"></script><link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link class="quarto-color-scheme" href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<link class="quarto-color-scheme quarto-color-alternate" rel="prefetch" href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script><link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link class="quarto-color-scheme" href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<link class="quarto-color-scheme quarto-color-alternate" rel="prefetch" href="../site_libs/bootstrap/bootstrap-dark.min.css">
<script id="quarto-search-options" type="application/json">{
    "location": "navbar",
    "copy-button": false,
    "collapse-after": 2,
    "panel-placement": "end",
    "type": "overlay",
    "limit": 20,
    "language": {
      "search-no-results-text": "No results",
      "search-matching-documents-text": "matching documents",
      "search-copy-link-title": "Copy link to search",
      "search-hide-matches-text": "Hide additional matches",
      "search-more-match-text": "more match in this document",
      "search-more-matches-text": "more matches in this document",
      "search-clear-button-title": "Clear",
      "search-detached-cancel-button-title": "Cancel",
      "search-submit-button-title": "Submit"
    }
  }</script><script type="text/javascript">

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-20375833-3', 'auto');

  ga('send', {
    hitType: 'pageview',
    'anonymizeIp': true,
  });
  </script><!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]--><link rel="stylesheet" href="../styles.css">
</head>
<body class="floating">
<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <img src="../images/favicon/apple-touch-icon.png" alt=""><span class="navbar-title">sparklyr</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../get-started/index.html">Get Started</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../guides/index.html" aria-current="page">Guides</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../deployment/index.html">Deployment</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../packages/sparklyr/latest/news.html">News</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../packages/sparklyr/latest/reference/index.html">Reference</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../packages/index.html">Packages</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../learn-more.html">Learn more</a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sparklyr/sparklyr"><i class="bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
<div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Text mining with Spark &amp; sparklyr</h1>
      <button type="button" class="quarto-btn-toggle btn">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="sidebar-tools-main">
</div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/index.html" class="sidebar-item-text ">Overview</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text text-start  " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-interacting-with-spark" aria-expanded="true">Interacting with Spark</a>
      <a class="sidebar-item-toggle text-start  " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-interacting-with-spark" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-interacting-with-spark" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/dplyr.html" class="sidebar-item-text ">Using <code>dplyr</code></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/caching.html" class="sidebar-item-text ">Managing Spark cache</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/connections.html" class="sidebar-item-text ">Spark connection options</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/aws-s3.html" class="sidebar-item-text ">Access S3 buckets</a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text text-start  " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-machine-learning" aria-expanded="true">Machine Learning</a>
      <a class="sidebar-item-toggle text-start  " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-machine-learning" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-machine-learning" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/mlib.html" class="sidebar-item-text ">Spark ML Overview</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/pipelines.html" class="sidebar-item-text ">ML Pipelines</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/h2o.html" class="sidebar-item-text ">H2O models</a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text text-start  " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-non-rectangular-data" aria-expanded="true">Non-rectangular Data</a>
      <a class="sidebar-item-toggle text-start  " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-non-rectangular-data" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-non-rectangular-data" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/streaming.html" class="sidebar-item-text ">Streaming Data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/textmining.html" class="sidebar-item-text active">Text Data</a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text text-start  " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-advanced" aria-expanded="true">Advanced</a>
      <a class="sidebar-item-toggle text-start  " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-advanced" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-advanced" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/distributed-r.html" class="sidebar-item-text ">Run R code inside Spark</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/extensions.html" class="sidebar-item-text ">Create <code>sparklyr</code> extensions</a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guides/troubleshooting.html" class="sidebar-item-text ">Troubleshooting</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">On this page</h2>
<ul>
<li><a href="#data-source" class="nav-link active" data-scroll-target="#data-source">Data source</a></li>
<li>
<a href="#data-import" class="nav-link" data-scroll-target="#data-import">Data Import</a>
<ul class="collapse">
<li><a href="#connect-to-spark" class="nav-link" data-scroll-target="#connect-to-spark">Connect to Spark</a></li>
<li><a href="#spark_read_text" class="nav-link" data-scroll-target="#spark_read_text">spark_read_text()</a></li>
</ul>
</li>
<li>
<a href="#data-transformation" class="nav-link" data-scroll-target="#data-transformation">Data transformation</a>
<ul class="collapse">
<li><a href="#sdf_bind_rows" class="nav-link" data-scroll-target="#sdf_bind_rows"><code>sdf_bind_rows()</code></a></li>
<li><a href="#regexp_replace" class="nav-link" data-scroll-target="#regexp_replace"><code>regexp_replace()</code></a></li>
<li><a href="#ft_tokenizer" class="nav-link" data-scroll-target="#ft_tokenizer"><code>ft_tokenizer()</code></a></li>
<li><a href="#ft_stop_words_remover" class="nav-link" data-scroll-target="#ft_stop_words_remover"><code>ft_stop_words_remover()</code></a></li>
<li><a href="#explode" class="nav-link" data-scroll-target="#explode"><code>explode()</code></a></li>
<li><a href="#compute" class="nav-link" data-scroll-target="#compute"><code>compute()</code></a></li>
<li><a href="#full-code" class="nav-link" data-scroll-target="#full-code">Full code</a></li>
</ul>
</li>
<li>
<a href="#data-analysis" class="nav-link" data-scroll-target="#data-analysis">Data Analysis</a>
<ul class="collapse">
<li><a href="#words-used-the-most" class="nav-link" data-scroll-target="#words-used-the-most">Words used the most</a></li>
<li><a href="#words-used-by-doyle-and-not-twain" class="nav-link" data-scroll-target="#words-used-by-doyle-and-not-twain">Words used by Doyle and not Twain</a></li>
<li><a href="#twain-and-sherlock" class="nav-link" data-scroll-target="#twain-and-sherlock">Twain and Sherlock</a></li>
<li><a href="#instr-lower" class="nav-link" data-scroll-target="#instr-lower"><code>instr()</code> &amp; <code>lower()</code></a></li>
</ul>
</li>
<li>
<a href="#appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a>
<ul class="collapse">
<li><a href="#gutenbergr-package" class="nav-link" data-scroll-target="#gutenbergr-package"><code>gutenbergr</code> package</a></li>
</ul>
</li>
</ul></nav>
</div>
<!-- main -->
<main class="content"><header id="title-block-header"><h1 class="title d-none d-lg-block display-7">Text mining with Spark &amp; sparklyr</h1>
</header><p>This article focuses on a set of functions that can be used for text mining with Spark and <code>sparklyr</code>. The main goal is to illustrate how to perform most of the data preparation and analysis with commands that will run inside the Spark cluster, as opposed to locally in R. Because of that, the amount of data used will be small.</p>
<section id="data-source" class="level3"><h3 class="anchored" data-anchor-id="data-source">Data source</h3>
<p>For this example, there are two files that will be analyzed. They are both the full works of Sir Arthur Conan Doyle and Mark Twain. The files were downloaded from the <a href="https://www.gutenberg.org/">Gutenberg Project</a> site via the <code>gutenbergr</code> package. Intentionally, no data cleanup was done to the files prior to this analysis. See the appendix below to see how the data was downloaded and prepared.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="st">"arthur_doyle.txt"</span>, <span class="fl">10</span><span class="op">)</span></code></pre></div>
<div class="cell-output-stdout">
<pre><code> [1] "cover"                         ""                             
 [3] ""                              ""                             
 [5] "The Return of Sherlock Holmes" ""                             
 [7] ""                              ""                             
 [9] "by Sir Arthur Conan Doyle"     ""                             </code></pre>
</div>
</div>
</section><section id="data-import" class="level2"><h2 class="anchored" data-anchor-id="data-import">Data Import</h2>
<section id="connect-to-spark" class="level3"><h3 class="anchored" data-anchor-id="connect-to-spark">Connect to Spark</h3>
<p>An additional goal of this article is to encourage the reader to try it out, so a simple Spark local mode session is used.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://spark.rstudio.com/">sparklyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark-connections.html">spark_connect</a></span><span class="op">(</span>master <span class="op">=</span> <span class="st">"local"</span><span class="op">)</span></code></pre></div>
</div>
</section><section id="spark_read_text" class="level3"><h3 class="anchored" data-anchor-id="spark_read_text">spark_read_text()</h3>
<p>The <code><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark_read_text.html">spark_read_text()</a></code> is a new function which works like <code><a href="https://rdrr.io/r/base/readLines.html">readLines()</a></code> but for <code>sparklyr</code>. It comes in handy when non-structured data, such as lines in a book, is what is available for analysis.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Imports Mark Twain's file</span>

<span class="va">twain_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"file:///"</span>, <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/mark_twain.txt"</span><span class="op">)</span>
<span class="va">twain</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark_read_text.html">spark_read_text</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"twain"</span>, <span class="va">twain_path</span><span class="op">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Imports Sir Arthur Conan Doyle's file</span>
<span class="va">doyle_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"file:///"</span>, <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/arthur_doyle.txt"</span><span class="op">)</span>
<span class="va">doyle</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark_read_text.html">spark_read_text</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"doyle"</span>, <span class="va">doyle_path</span><span class="op">)</span></code></pre></div>
</div>
</section></section><section id="data-transformation" class="level2"><h2 class="anchored" data-anchor-id="data-transformation">Data transformation</h2>
<p>The objective is to end up with a tidy table inside Spark with one row per word used. The steps will be:</p>
<ol type="1">
<li><p>The needed data transformations apply to the data from both authors. The data sets will be appended to one another</p></li>
<li><p>Punctuation will be removed</p></li>
<li><p>The words inside each line will be separated, or tokenized</p></li>
<li><p>For a cleaner analysis, stop words will be removed</p></li>
<li><p>To tidy the data, each word in a line will become its own row</p></li>
<li><p>The results will be saved to Spark memory</p></li>
</ol>
<section id="sdf_bind_rows" class="level3"><h3 class="anchored" data-anchor-id="sdf_bind_rows"><code>sdf_bind_rows()</code></h3>
<ul>
<li>
<code><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_bind.html">sdf_bind_rows()</a></code> appends the <code>doyle</code> Spark Dataframe to the <code>twain</code> Spark Dataframe. This function can be used in lieu of a <code><a href="https://dplyr.tidyverse.org/reference/bind.html">dplyr::bind_rows()</a></code> wrapper function. For this exercise, the column <code>author</code> is added to differentiate between the two bodies of work.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_words</span> <span class="op">&lt;-</span> <span class="va">doyle</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"doyle"</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_bind.html">sdf_bind_rows</a></span><span class="op">(</span><span class="op">{</span>
    <span class="va">twain</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"twain"</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span><span class="op">(</span><span class="va">line</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
</div>
</section><section id="regexp_replace" class="level3"><h3 class="anchored" data-anchor-id="regexp_replace"><code>regexp_replace()</code></h3>
<ul>
<li>The Hive UDF, <strong>regexp_replace</strong>, is used as a sort of <code><a href="https://rdrr.io/r/base/grep.html">gsub()</a></code> that works inside Spark. In this case it is used to remove punctuation. The usual <code>[:punct:]</code> regular expression did not work well during development, so a custom list is provided. For more information, see the <a href="https://spark.rstudio.com/dplyr/#hive-functions">Hive Functions</a> section in the <code>dplyr</code> page.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_words</span> <span class="op">&lt;-</span> <span class="va">all_words</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>line <span class="op">=</span> <span class="fu">regexp_replace</span><span class="op">(</span><span class="va">line</span>, <span class="st">"[_\"\'():;,.!?\\-]"</span>, <span class="st">" "</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</section><section id="ft_tokenizer" class="level3"><h3 class="anchored" data-anchor-id="ft_tokenizer"><code>ft_tokenizer()</code></h3>
<ul>
<li>
<code><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/ft_tokenizer.html">ft_tokenizer()</a></code> uses the Spark API to separate each word. It creates a new list column with the results.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_words</span> <span class="op">&lt;-</span> <span class="va">all_words</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/ft_tokenizer.html">ft_tokenizer</a></span><span class="op">(</span>
      input_col <span class="op">=</span> <span class="st">"line"</span>,
      output_col <span class="op">=</span> <span class="st">"word_list"</span>
      <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_words</span>, <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="cell-output-stdout">
<pre><code># Source: spark&lt;?&gt; [?? x 3]
  line                          author word_list 
  &lt;chr&gt;                         &lt;chr&gt;  &lt;list&gt;    
1 cover                         doyle  &lt;list [1]&gt;
2 The Return of Sherlock Holmes doyle  &lt;list [5]&gt;
3 by Sir Arthur Conan Doyle     doyle  &lt;list [5]&gt;
4 Contents                      doyle  &lt;list [1]&gt;</code></pre>
</div>
</div>
</section><section id="ft_stop_words_remover" class="level3"><h3 class="anchored" data-anchor-id="ft_stop_words_remover"><code>ft_stop_words_remover()</code></h3>
<ul>
<li>
<code><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/ft_stop_words_remover.html">ft_stop_words_remover()</a></code> is a new function that, as its name suggests, takes care of removing stop words from the previous transformation. It expects a list column, so it is important to sequence it correctly after a <code><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/ft_tokenizer.html">ft_tokenizer()</a></code> command. In the sample results, notice that the new <code>wo_stop_words</code> column contains less items than <code>word_list</code>.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_words</span> <span class="op">&lt;-</span> <span class="va">all_words</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/ft_stop_words_remover.html">ft_stop_words_remover</a></span><span class="op">(</span>
    input_col <span class="op">=</span> <span class="st">"word_list"</span>,
    output_col <span class="op">=</span> <span class="st">"wo_stop_words"</span>
    <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_words</span>, <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="cell-output-stdout">
<pre><code># Source: spark&lt;?&gt; [?? x 4]
  line                          author word_list  wo_stop_words
  &lt;chr&gt;                         &lt;chr&gt;  &lt;list&gt;     &lt;list&gt;       
1 cover                         doyle  &lt;list [1]&gt; &lt;list [1]&gt;   
2 The Return of Sherlock Holmes doyle  &lt;list [5]&gt; &lt;list [3]&gt;   
3 by Sir Arthur Conan Doyle     doyle  &lt;list [5]&gt; &lt;list [4]&gt;   
4 Contents                      doyle  &lt;list [1]&gt; &lt;list [1]&gt;   </code></pre>
</div>
</div>
</section><section id="explode" class="level3"><h3 class="anchored" data-anchor-id="explode"><code>explode()</code></h3>
<ul>
<li>The Hive UDF <strong>explode</strong> performs the job of unnesting the tokens into their own row. Some further filtering and field selection is done to reduce the size of the dataset.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_words</span> <span class="op">&lt;-</span> <span class="va">all_words</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>word <span class="op">=</span> <span class="fu">explode</span><span class="op">(</span><span class="va">wo_stop_words</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/select.html">select</a></span><span class="op">(</span><span class="va">word</span>, <span class="va">author</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span><span class="op">(</span><span class="va">word</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_words</span>, <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="cell-output-stdout">
<pre><code># Source: spark&lt;?&gt; [?? x 2]
  word     author
  &lt;chr&gt;    &lt;chr&gt; 
1 cover    doyle 
2 return   doyle 
3 sherlock doyle 
4 holmes   doyle </code></pre>
</div>
</div>
</section><section id="compute" class="level3"><h3 class="anchored" data-anchor-id="compute"><code>compute()</code></h3>
<ul>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> will operate this transformation and cache the results in Spark memory. It is a good idea to pass a name to <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> to make it easier to identify it inside the Spark environment. In this case the name will be <em>all_words</em>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_words</span> <span class="op">&lt;-</span> <span class="va">all_words</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="st">"all_words"</span><span class="op">)</span></code></pre></div>
</div>
</section><section id="full-code" class="level3"><h3 class="anchored" data-anchor-id="full-code">Full code</h3>
<p>This is what the code would look like on an actual analysis:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_words</span> <span class="op">&lt;-</span> <span class="va">doyle</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"doyle"</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_bind.html">sdf_bind_rows</a></span><span class="op">(</span><span class="op">{</span>
    <span class="va">twain</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"twain"</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span><span class="op">(</span><span class="va">line</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>line <span class="op">=</span> <span class="fu">regexp_replace</span><span class="op">(</span><span class="va">line</span>, <span class="st">"[_\"\'():;,.!?\\-]"</span>, <span class="st">" "</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/ft_tokenizer.html">ft_tokenizer</a></span><span class="op">(</span>
    input_col <span class="op">=</span> <span class="st">"line"</span>,
    output_col <span class="op">=</span> <span class="st">"word_list"</span>
  <span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/ft_stop_words_remover.html">ft_stop_words_remover</a></span><span class="op">(</span>
    input_col <span class="op">=</span> <span class="st">"word_list"</span>,
    output_col <span class="op">=</span> <span class="st">"wo_stop_words"</span>
  <span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>word <span class="op">=</span> <span class="fu">explode</span><span class="op">(</span><span class="va">wo_stop_words</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/select.html">select</a></span><span class="op">(</span><span class="va">word</span>, <span class="va">author</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span><span class="op">(</span><span class="va">word</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="st">"all_words"</span><span class="op">)</span></code></pre></div>
</div>
</section></section><section id="data-analysis" class="level2"><h2 class="anchored" data-anchor-id="data-analysis">Data Analysis</h2>
<section id="words-used-the-most" class="level3"><h3 class="anchored" data-anchor-id="words-used-the-most">Words used the most</h3>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">word_count</span> <span class="op">&lt;-</span> <span class="va">all_words</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">author</span>, <span class="va">word</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">word_count</span></code></pre></div>
<div class="cell-output-stdout">
<pre><code># Source: spark&lt;?&gt; [?? x 3]
   author word              n
   &lt;chr&gt;  &lt;chr&gt;         &lt;dbl&gt;
 1 doyle  empty           398
 2 doyle  students        109
 3 doyle  golden          303
 4 doyle  abbey           164
 5 doyle  grange           18
 6 doyle  year            866
 7 doyle  world          1520
 8 doyle  circumstances   284
 9 doyle  particulars      49
10 doyle  crime           357
# … with more rows</code></pre>
</div>
</div>
</section><section id="words-used-by-doyle-and-not-twain" class="level3"><h3 class="anchored" data-anchor-id="words-used-by-doyle-and-not-twain">Words used by Doyle and not Twain</h3>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">doyle_unique</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">word_count</span>, <span class="va">author</span> <span class="op">==</span> <span class="st">"doyle"</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">word_count</span>, <span class="va">author</span> <span class="op">==</span> <span class="st">"twain"</span><span class="op">)</span>, 
    by <span class="op">=</span> <span class="st">"word"</span>
    <span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="st">"doyle_unique"</span><span class="op">)</span>

<span class="va">doyle_unique</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span></code></pre></div>
<div class="cell-output-stdout">
<pre><code># Source:     spark&lt;?&gt; [?? x 3]
# Ordered by: -n
   author word          n
   &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;
 1 doyle  nigel       972
 2 doyle  alleyne     500
 3 doyle  ezra        421
 4 doyle  maude       337
 5 doyle  aylward     336
 6 doyle  lestrade    311
 7 doyle  catinat     301
 8 doyle  sharkey     281
 9 doyle  summerlee   248
10 doyle  congo       211
# … with more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">doyle_unique</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/collect.html">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="fu">wordcloud</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/wordcloud/man/wordcloud.html">wordcloud</a></span><span class="op">(</span>
    <span class="va">word</span>,
    <span class="va">n</span>,
    colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#56B4E9"</span><span class="op">)</span>
  <span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="textmining_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="twain-and-sherlock" class="level3"><h3 class="anchored" data-anchor-id="twain-and-sherlock">Twain and Sherlock</h3>
<p>The word cloud highlighted something interesting. The word <strong>“lestrade”</strong> is listed as one of the words used by Doyle but not Twain. Lestrade is the last name of a major character in the Sherlock Holmes books. It makes sense that the word “sherlock” appears considerably more times than “lestrade” in Doyle’s books, so why is Sherlock not in the word cloud? Did Mark Twain use the word “sherlock” in his writings?</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_words</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">author</span> <span class="op">==</span> <span class="st">"twain"</span>,
    <span class="va">word</span> <span class="op">==</span> <span class="st">"sherlock"</span>
    <span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="cell-output-stdout">
<pre><code># Source: spark&lt;?&gt; [?? x 1]
      n
  &lt;dbl&gt;
1    16</code></pre>
</div>
</div>
<p>The <code>all_words</code> table <strong>contains 16 instances</strong> of the word <strong>sherlock</strong> in the words used by Twain in his works. The <strong>instr</strong> Hive UDF is used to extract the lines that contain that word in the <code>twain</code> table. This Hive function works can be used instead of <code><a href="https://rdrr.io/r/base/grep.html">base::grep()</a></code> or <code><a href="https://stringr.tidyverse.org/reference/str_detect.html">stringr::str_detect()</a></code>. To account for any word capitalization, the <strong>lower</strong> command will be used in <code><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate()</a></code> to make all words in the full text lower cap.</p>
</section><section id="instr-lower" class="level3"><h3 class="anchored" data-anchor-id="instr-lower">
<code>instr()</code> &amp; <code>lower()</code>
</h3>
<p>Most of these lines are in a short story by Mark Twain called <a href="https://www.gutenberg.org/files/3180/3180-h/3180-h.htm#link2H_4_0008">A Double Barrelled Detective Story</a>. As per the <a href="https://en.wikipedia.org/wiki/A_Double_Barrelled_Detective_Story">Wikipedia</a> page about this story, this is a satire by Twain on the mystery novel genre, published in 1902.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">twain</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/mutate.html">mutate</a></span><span class="op">(</span>line <span class="op">=</span> <span class="fu">lower</span><span class="op">(</span><span class="va">line</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">instr</span><span class="op">(</span><span class="va">line</span>, <span class="st">"sherlock"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">line</span><span class="op">)</span></code></pre></div>
<div class="cell-output-stdout">
<pre><code> [1] "late sherlock holmes, and yet discernible by a member of a race charged" 
 [2] "sherlock holmes."                                                        
 [3] "“uncle sherlock! the mean luck of it!--that he should come just"         
 [4] "another trouble presented itself. “uncle sherlock 'll be wanting to talk"
 [5] "flint buckner's cabin in the frosty gloom. they were sherlock holmes and"
 [6] "“uncle sherlock's got some work to do, gentlemen, that 'll keep him till"
 [7] "“by george, he's just a duke, boys! three cheers for sherlock holmes,"   
 [8] "he brought sherlock holmes to the billiard-room, which was jammed with"  
 [9] "of interest was there--sherlock holmes. the miners stood silent and"     
[10] "the room; the chair was on it; sherlock holmes, stately, imposing,"      
[11] "“you have hunted me around the world, sherlock holmes, yet god is my"    
[12] "“if it's only sherlock holmes that's troubling you, you needn't worry"   
[13] "they sighed; then one said: “we must bring sherlock holmes. he can be"   
[14] "i had small desire that sherlock holmes should hang for my deeds, as you"
[15] "“my name is sherlock holmes, and i have not been doing anything.”"       
[16] "late sherlock holmes, and yet discernible by a member of a race charged" </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark-connections.html">spark_disconnect</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span></code></pre></div>
</div>
</section></section><section id="appendix" class="level2"><h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<section id="gutenbergr-package" class="level3"><h3 class="anchored" data-anchor-id="gutenbergr-package">
<code>gutenbergr</code> package</h3>
<p>This is an example of how the data for this article was pulled from the Gutenberg site:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/gutenbergr/">gutenbergr</a></span><span class="op">)</span>

<span class="fu"><a href="https://docs.ropensci.org/gutenbergr/reference/gutenberg_works.html">gutenberg_works</a></span><span class="op">(</span><span class="op">)</span>  <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">author</span> <span class="op">==</span> <span class="st">"Twain, Mark"</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">gutenberg_id</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/gutenbergr/reference/gutenberg_download.html">gutenberg_download</a></span><span class="op">(</span>mirror <span class="op">=</span> <span class="st">"http://mirrors.xmission.com/gutenberg/"</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op"><a href="https://spark.rstudio.com/packages/sparklyr/latest/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span><span class="op">(</span><span class="st">"mark_twain.txt"</span><span class="op">)</span></code></pre></div>


</section></section></main><!-- /main --><script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
    } else {
      disableStylesheet(alternateStylesheets);
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      return window.localStorage.getItem("quarto-color-scheme");
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = null;
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.id = "quarto-color-scheme-toggle";
    a.classList.add('top-right');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../guides/streaming.html">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Streaming Data</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../guides/distributed-r.html">
        <span class="nav-page-text">Run R code inside Spark</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->


</body>
</html>
